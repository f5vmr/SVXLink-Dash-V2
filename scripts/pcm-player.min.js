// --- Shared WebSocket connection (one per tab) ---
const wsPort = 8001;
const ws = new WebSocket("ws://" + document.location.hostname + ":" + wsPort);
ws.binaryType = 'arraybuffer';

window.svxp = null;

// Handle all messages (listener count + audio)
ws.onmessage = (event) => {
    if (typeof event.data === 'string') {
        try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'listenerCount') {
                updateListenerCountDisplay(msg.count);
            }
        } catch (e) {
            // Ignore invalid JSON
        }
    } else if (window.svxp && window.svxp.isPlaying && window.svxp.player) {
        // Feed audio if player is active
        window.svxp.player.feed(event.data);
    }
};

function PCMPlayer(t) {
    this.init(t);
}

function iOS() {
    return ["iPad Simulator", "iPhone Simulator", "iPod Simulator", "iPad", "iPhone", "iPod"].includes(navigator.platform) ||
           (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

function SVXPlayer(i) {
    this.sampleRate = iOS() ? 32000 : 48000;
    this.player = new PCMPlayer({
        encoding: "16bitInt",
        channels: 1,
        sampleRate: this.sampleRate
    });

    this.btn = i;
    this.btnDefault = i.style.backgroundColor;
    this.isPlaying = false;

    window.addEventListener("unload", () => this.destroy());
}

// Update a DOM element with the listener count
function updateListenerCountDisplay(count) {
    const el = document.getElementById('listenerCount');
    if (el) el.textContent = count > 0 ? `Listeners: ${count}` : '';
}

function playAudioToggle(t, i) {
    if (!window.svxp) window.svxp = new SVXPlayer(i);

    const svx = window.svxp;

    if (svx.isPlaying) {
        svx.stop();
        i.style.backgroundColor = svx.btnDefault;
    } else {
        svx.play();
        i.style.backgroundColor = 'green';
    }

    svx.isPlaying = !svx.isPlaying;
}

// --

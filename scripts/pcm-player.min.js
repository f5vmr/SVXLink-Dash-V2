function PCMPlayer(options) {
this.init(options);
}

function iOS() {
return ["iPad Simulator", "iPhone Simulator", "iPod Simulator", "iPad", "iPhone", "iPod"].includes(navigator.platform) ||
(navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

function SVXPlayer(port, buttonElement) {
this.ws = new WebSocket("ws://" + document.location.hostname + ":" + port);
this.sampleRate = iOS() ? 32000 : 48000;
this.player = new PCMPlayer({ encoding: "16bitInt", channels: 1, sampleRate: this.sampleRate });


this.btn = buttonElement;
this.btnDefault = buttonElement.style.backgroundColor;

// Audio + listener count handling
this.ws.binaryType = 'arraybuffer';
this.ws.onmessage = (event) => {
    if (typeof event.data === 'string') {
        try {
            const msg = JSON.parse(event.data);
            if (msg.type === 'listenerCount') {
                updateListenerCountDisplay(msg.count, this.btn);
            }
        } catch (e) {
            // Ignore invalid JSON
        }
    } else {
        this.player.feed(event.data);
    }
};

// Stop on unload
window.addEventListener("unload", () => {
    this.destroy();
});


}

// Update the listener count inside the button
function updateListenerCountDisplay(count, btn) {
if (!btn) return;
let el = btn.querySelector('.listenerCount');
if (!el) {
el = document.createElement('div');
el.className = 'listenerCount';
el.style.fontWeight = 'bold';
el.style.marginTop = '4px';
el.style.fontSize = '0.85em';
el.style.textAlign = 'center';
btn.appendChild(el);
}
el.textContent = count > 0 ? `Listeners: ${count}` : '';
}

function playAudioToggle(port, btn) {
if (window.svxp === undefined) {
window.svxp = new SVXPlayer(port, btn);
}
const player = window.svxp;
if (player.isPlaying && player.isPlaying()) {
player.stop();
btn.style.backgroundColor = player.btnDefault;
} else {
player.play();
btn.style.backgroundColor = 'green';
}
}

PCMPlayer.prototype.init = function(options) {
this.option = Object.assign({}, {
encoding: "16bitInt",
channels: 1,
sampleRate: 48000,
flushingTime: 1000
}, options);


this.samples = new Float32Array();
this.flush = this.flush.bind(this);
this.interval = setInterval(this.flush, this.option.flushingTime);
this.maxValue = this.getMaxValue();
this.typedArray = this.getTypedArray();
this.createContext();


};

PCMPlayer.prototype.getMaxValue = function() {
const maxValues = { "8bitInt": 128, "16bitInt": 32768, "32bitInt": 2147483648, "32bitFloat": 1 };
return maxValues[this.option.encoding] || maxValues["16bitInt"];
};

PCMPlayer.prototype.getTypedArray = function() {
const types = { "8bitInt": Int8Array, "16bitInt": Int16Array, "32bitInt": Int32Array, "32bitFloat": Float32Array };
return types[this.option.encoding] || types["16bitInt"];
};

PCMPlayer.prototype.createContext = function() {
this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
this.gainNode = this.audioCtx.createGain();
this.gainNode.gain.value = 1;
this.gainNode.connect(this.audioCtx.destination);
this.startTime = this.audioCtx.currentTime;
};

PCMPlayer.prototype.isTypedArray = function(buf) {
return buf.byteLength && buf.buffer && buf.buffer.constructor === ArrayBuffer;
};

PCMPlayer.prototype.feed = function(buf) {
if (this.isTypedArray(buf)) {
const formatted = this.getFormatedValue(buf);
const newSamples = new Float32Array(this.samples.length + formatted.length);
newSamples.set(this.samples, 0);
newSamples.set(formatted, this.samples.length);
this.samples = newSamples;
}
};

PCMPlayer.prototype.getFormatedValue = function(buf) {
const arr = new this.typedArray(buf.buffer);
const f32 = new Float32Array(arr.length);
for (let i = 0; i < arr.length; i++) {
f32[i] = arr[i] / this.maxValue;
}
return f32;
};

PCMPlayer.prototype.volume = function(value) {
this.gainNode.gain.value = value;
};

PCMPlayer.prototype.stop = function() {
if (this.interval) clearInterval(this.interval);
this.samples = null;
};

PCMPlayer.prototype.play = function() {
this.samples = new Float32Array();
this.interval = setInterval(this.flush, this.option.flushingTime);
};

PCMPlayer.prototype.destroy = function() {
this.stop();
if (this.audioCtx) this.audioCtx.close();
this.audioCtx = null;
};

PCMPlayer.prototype.flush = function() {
if (!this.samples.length) return;
const source = this.audioCtx.createBufferSource();
};

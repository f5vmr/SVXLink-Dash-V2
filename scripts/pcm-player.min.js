"use strict";const wsPort=8001;let sharedWS=null;function getSharedWebSocket(port){return sharedWS||(sharedWS=new WebSocket("ws://"+document.location.hostname+":"+port),sharedWS.binaryType="arraybuffer",sharedWS.onmessage=function(e){if("string"==typeof e.data)try{const t=JSON.parse(e.data);"listenerCount"===t.type&&updateListenerCountDisplay(t.count)}catch(t){}else window.svxp&&window.svxp.isPlaying&&window.svxp.player.feed(e.data)}),sharedWS}function updateListenerCountDisplay(e){const t=document.getElementById("listenerCount");t&&(t.textContent=e>0?`Listeners: ${e}`:"")}function PCMPlayer(e){this.init(e)}function iOS(){return["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform)||(navigator.userAgent.includes("Mac")&&"ontouchend"in document)}function SVXPlayer(t,i){this.ws=getSharedWebSocket(wsPort),this.sampleRate=iOS()?32000:48000,this.player=new PCMPlayer({encoding:"16bitInt",channels:1,sampleRate:this.sampleRate}),this.btn=i,this.btnDefault=i.style.backgroundColor,this.isPlaying=!1,window.addEventListener("unload",()=>this.destroy())}function playAudioToggle(t,i){if(!window.svxp)window.svxp=new SVXPlayer(t,i);const s=window.svxp;s.isPlaying?(s.stop(),i.style.backgroundColor=s.btnDefault,s.isPlaying=!1):(s.play(),i.style.backgroundColor="green",s.isPlaying=!0)}PCMPlayer.prototype.init=function(e){this.option=Object.assign({encoding:"16bitInt",channels:1,sampleRate:48000,flushingTime:1000},e),this.samples=new Float32Array,this.flush=this.flush.bind(this),this.interval=setInterval(this.flush,this.option.flushingTime),this.maxValue=this.getMaxValue(),this.typedArray=this.getTypedArray(),this.createContext()},PCMPlayer.prototype.getMaxValue=function(){const e={"8bitInt":128,"16bitInt":32768,"32bitInt":2147483648,"32bitFloat":1};return e[this.option.encoding]||e["16bitInt"]},PCMPlayer.prototype.getTypedArray=function(){const e={"8bitInt":Int8Array,"16bitInt":Int16Array,"32bitInt":Int32Array,"32bitFloat":Float32Array};return e[this.option.encoding]||e["16bitInt"]},PCMPlayer.prototype.createContext=function(){this.audioCtx=new(window.AudioContext||window.webkitAudioContext)(),this.gainNode=this.audioCtx.createGain(),this.gainNode.gain.value=1,this.gainNode.connect(this.audioCtx.destination),this.startTime=this.audioCtx.currentTime},PCMPlayer.prototype.isTypedArray=function(e){return e.byteLength&&e.buffer&&e.buffer.constructor==ArrayBuffer},PCMPlayer.prototype.feed=function(e){if(this.isTypedArray(e)){e=this.getFormatedValue(e);const t=new Float32Array(this.samples.length+e.length);t.set(this.samples,0),t.set(e,this.samples.length),this.samples=t}},PCMPlayer.prototype.getFormatedValue=function(e){const t=new this.typedArray(e.buffer),i=new Float32Array(t.length);for(let s=0;s<t.length;s++)i[s]=t[s]/this.maxValue;return i},PCMPlayer.prototype.volume=function(e){this.gainNode.gain.value=e},PCMPlayer.prototype.stop=function(){this.interval&&clearInterval(this.interval),this.samples=null},PCMPlayer.prototype.play=function(){this.samples=new Float32Array,this.interval=setInterval(this.flush,this.option.flushingTime)},PCMPlayer.prototype.destroy=function(){this.stop(),this.audioCtx&&this.audioCtx.close(),this.audioCtx=null},PCMPlayer.prototype.flush=function(){if(!this.samples.length)return;const e=this.audioCtx.createBufferSource(),t=this.audioCtx.createBuffer(1,this.samples.length,this.audioCtx.sampleRate);t.getChannelData(0).set(this.samples),e.buffer=t,e.connect(this.gainNode),e.start(),this.samples=new Float32Array()};

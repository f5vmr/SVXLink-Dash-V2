// Shared WebSocket connection
const wsPort = 8001;
let sharedWS = null;

function getSharedWebSocket() {
    if (!sharedWS) {
        sharedWS = new WebSocket("ws://" + document.location.hostname + ":" + wsPort);
        sharedWS.binaryType = 'arraybuffer';

        sharedWS.onmessage = (event) => {
            if (typeof event.data === 'string') {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'listenerCount') {
                        updateListenerCountDisplay(msg.count);
                    }
                } catch (e) {
                    // ignore invalid JSON
                }
            } else if (window.svxp && window.svxp.isPlaying && window.svxp.player) {
                window.svxp.player.feed(event.data);
            }
        };
    }
    return sharedWS;
}

// Global SVXPlayer instance
window.svxp = null;

// PCMPlayer class
function PCMPlayer(options) {
    this.init(options);
}

PCMPlayer.prototype.init = function(options) {
    this.options = Object.assign({
        encoding: "16bitInt",
        channels: 1,
        sampleRate: 48000,
        flushingTime: 1000
    }, options);

    this.samples = new Float32Array();
    this.flush = this.flush.bind(this);
    this.interval = setInterval(this.flush, this.options.flushingTime);
    this.maxValue = this.getMaxValue();
    this.typedArray = this.getTypedArray();
    this.createContext();
};

PCMPlayer.prototype.getMaxValue = function() {
    const maxValues = {
        "8bitInt": 128,
        "16bitInt": 32768,
        "32bitInt": 2147483648,
        "32bitFloat": 1
    };
    return maxValues[this.options.encoding] || maxValues["16bitInt"];
};

PCMPlayer.prototype.getTypedArray = function() {
    const types = {
        "8bitInt": Int8Array,
        "16bitInt": Int16Array,
        "32bitInt": Int32Array,
        "32bitFloat": Float32Array
    };
    return types[this.options.encoding] || types["16bitInt"];
};

PCMPlayer.prototype.createContext = function() {
    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    this.gainNode = this.audioCtx.createGain();
    this.gainNode.gain.value = 1;
    this.gainNode.connect(this.audioCtx.destination);
    this.startTime = this.audioCtx.currentTime;
};

PCMPlayer.prototype.isTypedArray = function(t) {
    return t.byteLength && t.buffer && t.buffer.constructor === ArrayBuffer;
};

PCMPlayer.prototype.feed = function(t) {
    if (this.isTypedArray(t)) {
        t = this.getFormattedValue(t);
        const newSamples = new Float32Array(this.samples.length + t.length);
        newSamples.set(this.samples, 0);
        newSamples.set(t, this.samples.length);
        this.samples = newSamples;
    }
};

PCMPlayer.prototype.getFormattedValue = function(t) {
    const arr = new this.typedArray(t.buffer);
    const f32 = new Float32Array(arr.length);
    for (let i = 0; i < arr.length; i++) f32[i] = arr[i] / this.maxValue;
    return f32;
};

PCMPlayer.prototype.volume = function(level) {
    this.gainNode.gain.value = level;
};

PCMPlayer.prototype.play = function() {
    this.samples = new Float32Array();
    if (!this.interval) this.interval = setInterval(this.flush, this.options.flushingTime);
};

PCMPlayer.prototype.stop = function() {
    if (this.interval) clearInterval(this.interval);
    this.interval = null;
    this.samples = new Float32Array();
};

PCMPlayer.prototype.destroy = function() {
    this.stop();
    if (this.audioCtx) this.audioCtx.close();
    this.audioCtx = null;
};

PCMPlayer.prototype.flush = function() {
    if (!this.samples.length) return;
    const bufferSource = this.audioCtx.createBufferSource();
    const audioBuffer = this.audioCtx.createBuffer(1, this.samples.length, this.audioCtx.sampleRate);
    audioBuffer.getChannelData(0).set(this.samples);
    bufferSource.buffer = audioBuffer;
    bufferSource.connect(this.gainNode);
    bufferSource.start();
    this.samples = new Float32Array();
};

// SVXPlayer class
function SVXPlayer(port, buttonEl) {
    this.ws = getSharedWebSocket(port);
    this.sampleRate = /iPad|iPhone|iPod/.test(navigator.platform) ? 32000 : 48000;
    this.player = new PCMPlayer({
        encoding: "16bitInt",
        channels: 1,
        sampleRate: this.sampleRate
    });

    this.btn = buttonEl;
    this.btnDefault = buttonEl.style.backgroundColor || '';
    this.isPlaying = false;

    window.addEventListener("unload", () => this.destroy());
}

SVXPlayer.prototype.togglePlay = function() {
    if (this.isPlaying) {
        this.player.stop();
        this.btn.style.backgroundColor = this.btnDefault;
    } else {
        this.player.play();
        this.btn.style.backgroundColor = 'green';
    }
    this.isPlaying = !this.isPlaying;
};

SVXPlayer.prototype.destroy = function() {
    this.player.destroy();
    this.ws = null;
};

// Listener count display
function updateListenerCountDisplay(count) {
    const el = document.getElementById('listenerCount');
    if (el) el.textContent = count > 0 ? `Listeners: ${count}` : '';
}

// Function to handle play button
function playAudioToggle(port, buttonEl) {
    if (!window.svxp) window.svxp = new SVXPlayer(port, buttonEl);
    window.svxp.togglePlay();
}

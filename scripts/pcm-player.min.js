// Shared WebSocket connection for all tabs
const wsPort = 8001;
let sharedWS = null;

function getSharedWebSocket() {
    if (!sharedWS) {
        sharedWS = new WebSocket("ws://" + document.location.hostname + ":" + wsPort);
        sharedWS.binaryType = 'arraybuffer';
        sharedWS.onmessage = (event) => {
            if (typeof event.data === 'string') {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'listenerCount') {
                        updateListenerCountDisplay(msg.count);
                    }
                } catch (e) {
                    // ignore invalid JSON
                }
            } else if (window.svxp && window.svxp.player) {
                // Always feed audio
                window.svxp.player.feed(event.data);
            }
        };
    }
    return sharedWS;
}

// Update the DOM with current listener count
function updateListenerCountDisplay(count) {
    const el = document.getElementById('listenerCount');
    if (el) el.textContent = count > 0 ? `Listeners: ${count}` : '';
}

// Detect iOS for sample rate
function iOS() {
    return ["iPad Simulator", "iPhone Simulator", "iPod Simulator", "iPad", "iPhone", "iPod"].includes(navigator.platform) ||
           (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

// PCM audio player
function PCMPlayer(options) {
    this.init(options);
}

PCMPlayer.prototype.init = function(options) {
    this.option = Object.assign({
        encoding: "16bitInt",
        channels: 1,
        sampleRate: 48000,
        flushingTime: 1000
    }, options);
    this.samples = new Float32Array();
    this.interval = setInterval(this.flush.bind(this), this.option.flushingTime);
    this.maxValue = this.getMaxValue();
    this.typedArray = this.getTypedArray();
    this.createContext();
};

PCMPlayer.prototype.getMaxValue = function() {
    const map = { "8bitInt": 128, "16bitInt": 32768, "32bitInt": 2147483648, "32bitFloat": 1 };
    return map[this.option.encoding] || 32768;
};

PCMPlayer.prototype.getTypedArray = function() {
    const map = { "8bitInt": Int8Array, "16bitInt": Int16Array, "32bitInt": Int32Array, "32bitFloat": Float32Array };
    return map[this.option.encoding] || Int16Array;
};

PCMPlayer.prototype.createContext = function() {
    this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    this.gainNode = this.audioCtx.createGain();
    this.gainNode.gain.value = 1;
    this.gainNode.connect(this.audioCtx.destination);
};

PCMPlayer.prototype.feed = function(data) {
    if (data && data.byteLength) {
        const arr = new this.typedArray(data.buffer);
        const f32 = new Float32Array(arr.length);
        for (let i = 0; i < arr.length; i++) f32[i] = arr[i] / this.maxValue;
        const newSamples = new Float32Array(this.samples.length + f32.length);
        newSamples.set(this.samples, 0);
        newSamples.set(f32, this.samples.length);
        this.samples = newSamples;
    }
};

PCMPlayer.prototype.flush = function() {
    if (!this.samples.length) return;
    const bufferSource = this.audioCtx.createBufferSource();
    const audioBuffer = this.audioCtx.createBuffer(1, this.samples.length, this.option.sampleRate);
    audioBuffer.getChannelData(0).set(this.samples);
    bufferSource.buffer = audioBuffer;
    bufferSource.connect(this.gainNode);
    bufferSource.start();
    this.samples = new Float32Array();
};

PCMPlayer.prototype.stop = function() {
    clearInterval(this.interval);
    this.samples = new Float32Array();
};

PCMPlayer.prototype.play = function() {
    this.samples = new Float32Array();
    this.interval = setInterval(this.flush.bind(this), this.option.flushingTime);
};

// SVXPlayer wrapper
function SVXPlayer(button) {
    this.ws = getSharedWebSocket();
    this.player = new PCMPlayer({ encoding: "16bitInt", channels: 1, sampleRate: iOS() ? 32000 : 48000 });
    this.button = button;
    // fallback to computed style if inline style is empty
    this.buttonDefault = button.style.backgroundColor || getComputedStyle(button).backgroundColor || 'blue';
    this.isPlaying = false;
}

SVXPlayer.prototype.togglePlay = function() {
    if (this.isPlaying) {
        this.player.stop();
        this.button.style.backgroundColor = this.buttonDefault;
    } else {
        this.player.play();
        this.button.style.backgroundColor = 'green';
    }
    this.isPlaying = !this.isPlaying;
};

// Global access
window.svxp = null;
function playAudioToggle(button) {
    if (!window.svxp) window.svxp = new SVXPlayer(button);
    window.svxp.togglePlay();
}

window.addEventListener("unload", () => {
    if (window.svxp) window.svxp.player.stop();
});

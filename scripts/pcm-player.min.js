/* Shared WebSocket â€“ one per tab */
const wsPort = 8001;
const sharedWS = new WebSocket(`ws://${document.location.hostname}:${wsPort}`);
sharedWS.binaryType = 'arraybuffer';

// Global player placeholder
window.svxp = null;

// Handle incoming messages (audio + listener count)
sharedWS.onmessage = (event) => {
if (typeof event.data === 'string') {
try {
const msg = JSON.parse(event.data);
if (msg.type === 'listenerCount') {
updateListenerCountDisplay(msg.count);
}
} catch (e) {
// ignore
}
} else if (window.svxp && window.svxp.isPlaying) {
// feed audio only when playing
window.svxp.player.feed(event.data);
}
};

// Update DOM element with listener count
function updateListenerCountDisplay(count) {
const el = document.getElementById('listenerCount');
if (el) el.textContent = count > 0 ? `Listeners: ${count}` : '';
}

// Detect iOS for sample rate
function iOS() {
return ["iPad Simulator","iPhone Simulator","iPod Simulator","iPad","iPhone","iPod"].includes(navigator.platform) ||
(navigator.userAgent.includes("Mac") && "ontouchend" in document);
}

// PCMPlayer class
function PCMPlayer(options) {
this.init(options);
}

PCMPlayer.prototype.init = function(options) {
this.option = Object.assign({
encoding: "16bitInt",
channels: 1,
sampleRate: 48000,
flushingTime: 1000
}, options);
this.samples = new Float32Array();
this.flush = this.flush.bind(this);
this.interval = setInterval(this.flush, this.option.flushingTime);
this.maxValue = this.getMaxValue();
this.typedArray = this.getTypedArray();
this.createContext();
};

PCMPlayer.prototype.getMaxValue = function() {
const map = { "8bitInt":128, "16bitInt":32768, "32bitInt":2147483648, "32bitFloat":1 };
return map[this.option.encoding] || 32768;
};

PCMPlayer.prototype.getTypedArray = function() {
const map = { "8bitInt":Int8Array, "16bitInt":Int16Array, "32bitInt":Int32Array, "32bitFloat":Float32Array };
return map[this.option.encoding] || Int16Array;
};

PCMPlayer.prototype.createContext = function() {
this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
this.gainNode = this.audioCtx.createGain();
this.gainNode.gain.value = 1;
this.gainNode.connect(this.audioCtx.destination);
};

PCMPlayer.prototype.feed = function(t) {
if (t.byteLength && t.buffer && t.buffer.constructor == ArrayBuffer) {
const arr = new this.typedArray(t.buffer);
const f32 = new Float32Array(arr.length);
for (let i=0;i<arr.length;i++) f32[i] = arr[i]/this.maxValue;
const tmp = new Float32Array(this.samples.length + f32.length);
tmp.set(this.samples,0);
tmp.set(f32,this.samples.length);
this.samples = tmp;
}
};

PCMPlayer.prototype.flush = function() {
if (!this.samples.length) return;
const bufferSource = this.audioCtx.createBufferSource();
const buffer = this.audioCtx.createBuffer(1, this.samples.length, this.option.sampleRate);
buffer.copyToChannel(this.samples,0);
bufferSource.buffer = buffer;
bufferSource.connect(this.gainNode);
bufferSource.start();
this.samples = new Float32Array();
};

PCMPlayer.prototype.stop = function() {
if (this.interval) clearInterval(this.interval);
this.samples = new Float32Array();
};

PCMPlayer.prototype.play = function() {
this.samples = new Float32Array();
this.interval = setInterval(this.flush, this.option.flushingTime);
};

PCMPlayer.prototype.destroy = function() {
this.stop();
if (this.audioCtx) this.audioCtx.close();
};

// SVXPlayer class
function SVXPlayer(ws, btn) {
this.ws = ws; // shared WebSocket
this.btn = btn;
this.btnDefault = btn.style.backgroundColor;
this.sampleRate = iOS() ? 32000 : 48000;
this.player = new PCMPlayer({ encoding:"16bitInt", channels:1, sampleRate:this.sampleRate });
this.isPlaying = false;

```
window.addEventListener("unload", () => this.destroy());
```

}

SVXPlayer.prototype.playToggle = function() {
if (!this.isPlaying) {
this.player.play();
this.btn.style.backgroundColor = 'green';
} else {
this.player.stop();
this.btn.style.backgroundColor = this.btnDefault;
}
this.isPlaying = !this.isPlaying;
};

SVXPlayer.prototype.destroy = function() {
this.player.destroy();
};

// Button handler
function playAudioToggle(btn) {
if (!window.svxp) window.svxp = new SVXPlayer(sharedWS, btn);
window.svxp.playToggle();
}

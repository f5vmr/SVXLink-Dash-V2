// =====================
// Shared WebSocket Setup
// =====================
const wsPort = 8001;
let sharedWS = null;

// Global player placeholder
window.svxp = null;

// Create one WebSocket per tab
function getSharedWebSocket(port) {
    if (!sharedWS) {
        sharedWS = new WebSocket("ws://" + document.location.hostname + ":" + port);
        sharedWS.binaryType = 'arraybuffer';

        // Handle all messages (listener count + audio)
        sharedWS.onmessage = (event) => {
            if (typeof event.data === 'string') {
                try {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'listenerCount') {
                        updateListenerCountDisplay(msg.count);
                    }
                } catch (e) {
                    // Ignore invalid JSON
                }
            } else if (window.svxp && window.svxp.isPlaying && window.svxp.player) {
                // Feed audio only if playback active
                window.svxp.player.feed(event.data);
            }
        };
    }
    return sharedWS;
}

// =====================
// SVXPlayer
// =====================
function SVXPlayer(t, i) {
    this.ws = getSharedWebSocket(t); // reuse shared connection
    this.sampleRate = iOS() ? 32000 : 48000;
    this.player = new PCMPlayer({
        encoding: "16bitInt",
        channels: 1,
        sampleRate: this.sampleRate
    });

    this.btn = i;
    this.btnDefault = i.style.backgroundColor;
    this.isPlaying = false;

    window.addEventListener("unload", () => this.destroy());
}

// =====================
// Listener Count Display
// =====================
function updateListenerCountDisplay(count) {
    const el = document.getElementById('listenerCount');
    if (el) el.textContent = count > 0 ? `Listeners: ${count}` : '';
}

// =====================
// Button Toggle
// =====================
function playAudioToggle(t, i) {
    if (!window.svxp) window.svxp = new SVXPlayer(t, i);

    if (window.svxp.isPlaying) {
        window.svxp.stop();
        i.style.backgroundColor = window.svxp.btnDefault;
    } else {
        window.svxp.play();
        i.style.backgroundColor = 'green';
    }

    window.svxp.isPlaying = !window.svxp.isPlaying;
}

// =====================
// iOS detection helper
// =====================
function iOS() {
    return ["iPad Simulator", "iPhone Simulator", "iPod Simulator", "iPad", "iPhone", "iPod"]
        .includes(navigator.platform)
        || (navigator.userAgent.includes("Mac") && "ontouchend" in document);
}
